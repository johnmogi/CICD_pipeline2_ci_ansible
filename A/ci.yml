steps:
  - script: |
      echo '''
        PORT: $(PORT)
        HOST: $(HOST)
        HOST_URL: $(HOST_URL)
        COOKIE_ENCRYPT_PWD: $(COOKIE_ENCRYPT_PWD)
        NODE_ENV: $(NODE_ENV)
        OKTA_ORG_URL: $(OKTA_ORG_URL)
        OKTA_CLIENT_ID: $(OKTA_CLIENT_ID)
        OKTA_CLIENT_SECRET: $(OKTA_CLIENT_SECRET)
        PGHOST: $(PGHOST)
        PGUSERNAME: $(PGUSERNAME)
        PGDATABASE: $(PGDATABASE)
        PGPASSWORD: $(PGPASSWORD)
        PGPORT: $(PGPORT)
        ''' > psecret.yml

  - task: CopyFiles@2
    inputs:
      SourceFolder: "$(Build.SourcesDirectory)"
      Contents: "**/**"
      TargetFolder: "$(build.artifactstagingdirectory)"
    displayName: "prepare artifacts"

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: "$(Build.BinariesDirectory)"
      includeRootFolder: true
      archiveType: "tar"
      archiveFile: "$(Build.ArtifactStagingDirectory)/artifact_ci.tar"
      replaceExistingArchive: true

  - task: PublishPipelineArtifact@1
    inputs:
      #  targetPath: '$(Pipeline.Workspace)'
      targetPath: "$(Build.ArtifactStagingDirectory)/artifact_ci.tar"
      artifact: "arti$(Build.BuildId)"
      publishLocation: "pipeline"

  - task: UniversalPackages@0
    inputs:
      command: "publish"
      publishDirectory: "$(Build.ArtifactStagingDirectory)"
      feedsToUsePublish: "internal"
      vstsFeedPublish: "f3be00d4-d77a-40e2-a0a4-997840fa8608"
      vstsFeedPackagePublish: "arti"
      versionOption: "patch"

  - task: ExtractFiles@1
    inputs:
      archiveFilePatterns: "../**/*.tar"
      destinationFolder: "ansible"
      cleanDestinationFolder: true
      overwriteExistingFiles: false

  # - script: rm -rf ~/ansible  2> /dev/null
  #   displayName: Remove app

  - script: mkdir -p ~/ansible/
    displayName: Make directory app to ansible files directory
  - checkout: self
    displayName: Download ansible files

  - script: cp -R $(System.DefaultWorkingDirectory)/. ~/ansible/
    displayName: Copy ansible files

  - script: |
      curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
      python3 get-pip.py --user
      python3 -m pip install --user ansible
      python3 -m pip install --user argcomplete
      PATH=$PATH:~/.local/bin
      export PATH=$PATH:/home/adminuser/.local/bin
      export PATH=$PATH:/home/adminuser/.local/bin/ansible
      export PATH=$PATH:~/.local/bin/ansible
    displayName: install ansible and docker

  # - script: |
  #     cd ~/.ssh && ssh-keygen -t ed25519 -C "ansible"
  #     ansible
  #     chmod 400 id_ed25519.pub
  #     ssh-copy-id -i id_ed25519.pub 10.0.20.4
  #   displayName: install keys for ansible
