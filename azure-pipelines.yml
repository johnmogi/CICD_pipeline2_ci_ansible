trigger:
  batch: true
  branches:
    include:
      - main
variables:
  - group: staging
pool:
  name: Default
  vmImage: "terraformAgent"

stages:

# Continuous Integration Process
- stage: CI
  jobs:
  - job: BuildAndPushDocker
    workspace: 
      clean: all
    steps:
    - task: CopyFiles@2
      inputs:
        SourceFolder: "$(Build.SourcesDirectory)"
        Contents: "**/**"
        TargetFolder: "$(build.artifactstagingdirectory)"
      displayName: "prepare artifacts"

    - task: UniversalPackages@0
      inputs:
        command: "publish"
        publishDirectory: "$(Build.ArtifactStagingDirectory)"
        feedsToUsePublish: "internal"
        vstsFeedPublish: "f3be00d4-d77a-40e2-a0a4-997840fa8608"
        vstsFeedPackagePublish: "ci"
        versionOption: "patch"

# Continuous Deployment Process for Staging Environment
- stage: DeployToStaging
  condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
  jobs:
  - deployment: staging
    displayName: Deploy to Staging
    environment:
      name: staging
      resourceType: VirtualMachine
    strategy:
      runOnce:
        deploy:
          steps:
          - task: CmdLine@2
            inputs:
              script: |
                echo Write your commands here
                
                echo Hello world
          
   